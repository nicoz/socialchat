<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <style>
        body
        {
            background-color: SlateGray  ;
            padding-top:80px;
        }
        #users_list_header
        {
            color: OliveDrab;
        }
        .label
        {
            border-top-right-radius: 1em;
            border-top-left-radius: 1em;
            border-bottom-right-radius: 1em;
            box-shadow: 1px -1px 40px LightBlue;

            padding: 10px;

            margin-left: 10px;
            margin-bottom: 10px;

            color: SteelGray;
            font-size: 15px;
            font-family: monospace;

            background-color: WhiteSmoke;
        }
        .message, #bar-users, #bar-send, #bar-login, #bar-user,#about_us
        {
            border-bottom-left-radius: 1em;
            border-top-left-radius: 1em;
            border-top-right-radius: 1em;
            border-bottom-right-radius: 1em;
        }

        .message
        {
            padding: 20px;
            margin-bottom: 30px;

            color: WhiteSmoke;
            text-shadow: black 0.1em 0.1em 0.1em;
            font-size: 15px;
            position:static;//left: 40px;bottom:90px; top:20px; right: 20px;
            box-shadow: 0px 0px 20px LightBlue;
            font-family: monospace;
            background-color: rgba(0,0,0,0.5);//Gainsboro;
        }
        #bar-users, #about_us{
            padding:10px;
            color: SteelGray;
            font-size: 15px;
            position:fixed;left:0px;top:0px;
            box-shadow: 1px -1px 40px LightBlue;
            font-family: monospace;
        }

        #bar-user{
            padding:10px;
            color: SteelGray;
            font-size: 15px;
            position:fixed;right:0px;top:0px;
            box-shadow: 1px -1px 40px LightBlue;
            font-family: monospace;
            font-weight:bold;
        }

        #bar-login{
            padding:20px;
            color: WhiteSmoke;
            text-shadow: black 0.1em 0.1em 0.1em;
            font-size: 15px;
            position:fixed;
            left: 40%;
            top: 40%;

            box-shadow: 0px 0px 20px LightBlue;
            font-family: monospace;
            //background-color: rgba(255,255,240,0.7);
            background-color: rgba(0,0,0,0.7);

        }
        #bar-send{
            padding:20px;
            margin-bottom: 30px;
            color: WhiteSmoke;
            text-shadow: black 0.1em 0.1em 0.1em;
            font-size: 15px;
            position:fixed;
            left: 40%;
            top: 10px;

            box-shadow: 0px 0px 20px LightBlue;
            font-family: monospace;
            background-color: rgba(255,255,240,0.7);
            //background-color: rgba(0,0,0,0.7);

        }
        </style>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="http://underscorejs.org/underscore-min.js"></script>
        <script>
            var logged = false;
            var socket = io.connect('http://localhost:7500');
            socket.on('user disconnected', function(data) {
                console.log(data);
                updateUsers(data.users);
            });
            socket.on('new message',function(data){
                if (logged){
                    var new_message = $('<div class="message">');
                    who = data.user_sender.nickname;
                    if (who == nick)
                        who = "You";
                    new_message.append($('<strong>').text( who + ":"));
                    new_message.append($('<p>').text(data.text));
                    $("body").prepend(new_message);
                }
            });
            socket.on('user added', function(data) {
                console.log(data);
                $("#about_us").hide();
                $("#users_list_header").show();
                updateUsers(data.users);
                if(data.user.nickname == nick){
                        logged = true;

                        $("#bar-users").show();
                        $("#about_us").hide();
                        $(".message").remove();
                        $("#bar-send").fadeIn();
                        $("#bar-login").fadeOut();

                        $("#user").fadeOut();
                        $("#user").text(nick);
                        $("#user").fadeIn();
                        $("#user").css("font","weight");


                        $("#user").click(function(){
                            socket.emit("loggout");
                            logged = false;
                            $(".message").remove();
                            $("#bar-send").fadeOut();
                            $("#about_us").show();
                            $("#users_list_header").hide();
                            $(this).css("background-color","");
                            $(this).unbind("click");
                            $(this).unbind("mouseover");
                            $(this).unbind("mouseout");
                            set();
                        });

                        $("#user").mouseover(function(){
                            $(this).fadeOut();
                            $(this).text("Loggout!");
                            $(this).fadeIn();
                            $(this).css("background-color","OliveDrab");
                            $(this).css("text-shadow"," black 0.1em 0.1em 0.1em");
                            $(this).css("color","WhiteSmoke");
                        });

                        $("#user").mouseout(function(){
                            $(this).css("text-shadow", "");
                            $(this).css("background-color","");
                            $(this).css("color","OliveDrab");
                            $(this).text(nick);
                        });
                }
            });

            var nick;
            function about_us_click(){
                if($('#about_us_mail').is (':visible')){
                    $("#about_us_name").text("I.io");
                    $("#about_us_mail").slideToggle();
                    $("#about_us").fadeOut();
                    $("#about_us").fadeIn();
                    //$("#about_us").css("transform","rotate(0deg)");
                    //$("#about_us").css("margin-top","0px");
                    $("#about_us").css("background-color","rgba(0,0,0,0.0)");
                }
                else{
                    $("#about_us_name").text("Imaginatio");
                    //$("#about_us").css("transform","rotate(5deg)");
                    //$("#about_us").css("margin-top","15px");
                    $("#about_us").css("background-color","rgba(255,255,240,0.7)");
                    //$("#about_us").css("background-color","rgba(255,255,255,1.0)");
                    $("#about_us_mail").slideToggle();
                }
            }

            function set(){

                $("#bar-users").hide();
                $("#about_us").show();
                $("#bar-login").fadeIn();
                nick = "";
                $("#nick").val("anon");
                $("#nick-button").text(" Login as: ");
                $(".content").hide();
                $("#about_us_mail").hide();
                $("#user").text("You have to login...");
                $("#user").css("color","OliveDrab");
                $("#user").css("text-shadow", "");
                $("#user").css("font-weight", "normal");
            }

            $(document).ready(function(){
                set();
                $("#bar-users").mouseover(function(){
                    $("#users_list").show();
                });
                $("#bar-users").mouseout(function(){
                    $("#users_list").hide();
                });
                $('#bar-send').hide();
                $('#send-button').click(function(){
                    if ( $('#send-text').val().trim() != "" )
                    socket.emit('new message', { text: $('#send-text').val() });
                });
                $('#users_list').hide();
                $("#about_us").click(about_us_click);
                $("#nick").css("margin-right","30px");
                $("#nick-button").click(function(){
                    nick= $("#nick").val();
                    if (nick == ""){
                        $(this).text("Empty nick!");
                    }
                    else{
                        socket.emit('add user', {id: '1234', nickname: nick, avatar: 'https://lh6.googleusercontent.com/-EnzpINF7hV0/AAAAAAAAAAI/AAAAAAAAAA8/iA2AaEhAfIA/w48-c-h48/photo.jpg'});
                    }
                });
            });

            function updateUsers(users){
                $("#users_list_header").html('');
                $("#users_list").html('');
                var count = 1;
                _.each(users, function(user) {
                    if ( user.nickname != nick )
                        count++;
                        $("#users_list").append("<div class='label'> " + user.nickname + " </div>");
                });
                $("#users_list_header").append("<div class='label'> " + String(count) + " users connected</div>");
             }
        </script>
    </head>
    <body>
        <div id="bar-login">
            <button id="nick-button"></button>
            <input id="nick"></input>
        </div>
        <div id="bar-users">
            <div id="users_list_header"> </div>
            <div id="users_list"> </div>
        </div>
        <div id="about_us">
            <div id="about_us_name" class="label"> I.io </div>
            <div id="about_us_mail" class="label"> sales.imaginatio@gmail.com </div>
        </div>
        <div id="bar-send">
            <button id="send-button">Send</button>
            <input id="send-text"></input>
        </div>
        <div id="bar-user">
            <div id="user" class="label"> </div>
        </div>
    </body>
</html>
