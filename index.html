<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <style>
        body
        {
            background-color: SlateGray  ;
            padding-top:80px;
        }
        .label
        {
            border-top-right-radius: 1em;
            border-top-left-radius: 1em;
            border-bottom-right-radius: 1em;
            box-shadow: 1px -1px 40px LightBlue;

            padding: 10px;

            margin-left: 10px;
            margin-bottom: 10px;

            color: SteelGray;
            font-size: 15px;
            font-family: monospace;

            background-color: WhiteSmoke;
        }
        .message
        {
            padding: 20px;
            margin-bottom: 30px;

            color: WhiteSmoke;
            text-shadow: black 0.1em 0.1em 0.1em;
            font-size: 15px;
            position:static;//left: 40px;bottom:90px; top:20px; right: 20px;
            box-shadow: 0px 0px 20px LightBlue;
            font-family: monospace;
            background-color: rgba(0,0,0,0.5);//Gainsboro;
        }
        .users_container{
            padding:10px;
            color: SteelGray;
            font-size: 15px;
            position:fixed;left:0px;top:0px;
            box-shadow: 1px -1px 40px LightBlue;
            font-family: monospace;
            padding:10px;
            color: SteelGray;
            font-size: 15px;
            position:fixed;right:0px;top:0px;
            box-shadow: 1px -1px 40px LightBlue;
            font-family: monospace;
            font-weight:bold;
            width: 100px;
        }

        .login_container{
            padding:20px;
            color: WhiteSmoke;
            text-shadow: black 0.1em 0.1em 0.1em;
            font-size: 15px;
            position:fixed;
            left: 40%;
            top: 40%;

            box-shadow: 0px 0px 20px LightBlue;
            font-family: monospace;
            //background-color: rgba(255,255,240,0.7);
            background-color: rgba(0,0,0,0.7);

        }
        .send_container{
            padding:20px;
            margin-bottom: 30px;
            color: WhiteSmoke;
            text-shadow: black 0.1em 0.1em 0.1em;
            font-size: 15px;
            position:fixed;
            left: 40%;
            top: 10px;

            box-shadow: 0px 0px 20px LightBlue;
            font-family: monospace;
            background-color: rgba(255,255,240,0.7);
            //background-color: rgba(0,0,0,0.7);

        }

        .content{
            max-height: 200px;
            overflow-y: scroll;
        }
        </style>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="http://underscorejs.org/underscore-min.js"></script>
        <script src="https://apis.google.com/js/plus.js"></script>
        <script src="https://apis.google.com/js/client:plus.js"></script>
        <script>
            var socket;
            $(document).ready(function(){
                window.___gcfg = {
                    lang: 'es-UY',
                    parsetags: 'explicit'
                }
                $.fn.users_list = function( userItemPrototype , options ) {
                    var self = this;
                    var settings = $.extend({
                        onDeleteUser: function() {},
                        onNewUser: function() {},
                        users: []
                    }, options );
                    _.each(settings.users, function(user) {
                        console.log(settings.users);
                        var userItem = userItemPrototype.replace(/\?nickname/g, user.nickname);
                        userItem = userItem.replace(/\?avatar/g, user.avatar);
                        userItem = userItem.replace(/\?id/g, user.id);
                        self.prepend(userItem);
                    });
                    socket.on('user added', function( data ) {
                        settings.users.push(data.user);
                        var userItem = userItemPrototype.replace(/\?nickname/g, data.user.nickname);
                        userItem = userItem.replace(/\?avatar/g, data.user.avatar);
                        userItem = userItem.replace(/\?id/g, data.user.id);
                        self.prepend(userItem);
                        settings.onNewUser.call( self, data.user, settings.users );
                    });
                    socket.on('user disconnected', function(data) {
                        console.log(data);
                        settings.users = _.reject(settings.users, function(user){ return user.nickname == data.user.nickname; });
                        self.html("");
                        _.each(settings.users, function(user) {
                            var userItem = userItemPrototype.replace(/\?nickname/g, user.nickname);
                            userItem = userItem.replace(/\?avatar/g, user.avatar);
                            userItem = userItem.replace(/\?id/g, user.id);
                            self.prepend(userItem);
                        });
                        settings.onDeleteUser.call( self, data.user, settings.users );
                    });
                }

                $.fn.public_messages = function( messageItemPrototype, options ) {
                    var self = this;
                    var settings =  $.extend({
                        messages: []
                    }, options );
                    _.each(settings.messages, function(message) {
                        var messageItem = messageItemPrototype.replace(/\?nickname/g, message.user_sender.nickname);
                        messageItem = messageItem.replace(/\?message/g, message.text);
                        messageItem = messageItem.replace(/\?avatar/g, message.user_sender.avatar);
                        messageItem = messageItem.replace(/\?id/g, message.user_sender.id);
                        self.prepend(messageItem);
                    });
                    socket.on('new message', function( data ) {
                        settings.messages.push(data);
                        var messageItem = messageItemPrototype.replace(/\?nickname/g, data.user_sender.nickname);
                        messageItem = messageItem.replace(/\?message/g, data.text);
                        messageItem = messageItem.replace(/\?avatar/g, data.user_sender.avatar);
                        messageItem = messageItem.replace(/\?id/g, data.user_sender.id);
                        self.prepend(messageItem);
                    });
                }

                $.fn.send = function( getMessageFrom ) {
                    var self = this;
                    self.bind( "click", function(){
                        socket.emit('new message', { text: getMessageFrom.val() });
                    });
                }

                $.chat = function( key){
                    socket = io.connect("/" + key);
                }

                $.login_with_google = function(options){
                    var settings =  $.extend({
                        onLogin: function() {},
                        onRefused: function() {}
                    }, options );
                    socket.on('user logged', function( data ) {
                        settings.onRefused = function() {};
                        settings.onLogin.call( this, data );
                        settings.onLogin = function() {};
                    });
                    socket.on("account in use", function(data){
                        settings.onLogin = function() {};
                        settings.onRefused.call( this, data );
                        settings.onRefused = function() {};
                    });
                    gapi.client.setApiKey("AIzaSyCPD31tBSm9-i5XlHQWJjlxQp8TQgOYjYc");
                    gapi.auth.authorize({
                        client_id:"763846340525-1ibca1dlcoiuto5qfu7ejl8321ddq3eh.apps.googleusercontent.com" ,
                        scope: "profile email" 
                        }, function(data){
                            console.log(data);
                            var xhr = new XMLHttpRequest();
                            xhr.open('GET', "https://www.googleapis.com/plus/v1/people/me/");
                            xhr.setRequestHeader('Authorization', 'Bearer ' + data.access_token);
                            xhr.send();
                            xhr.onreadystatechange = function(){
                                if (this.readyState == 4){
                                    var response = JSON.parse(xhr.responseText);
                                    console.log(response);
                                    console.log(response.image.url.split("?sz=50")[0]);
                                    socket.emit('add user', {
                                        id: response.id,
                                        nickname: response.name.givenName + ' ' + response.name.familyName,
                                        avatar: response.image.url.split("?sz=50")[0] 
                                    });
                                }
                            }
                        });
                }

                $.private_chats = function( messageItemPrototype, roomPrototype, options){
                    var settings =  $.extend({
                        onNewPrivateMessage: function() {},
                        onNewPrivateRoom: function() {},
                        rooms: [],
                        messagesTo: "",
                        roomTo: "",
                        button: "",
                        input: ""
                    }, options );
                    var roomTemplate = null;

                    socket.on('delete private', function( data ) {
                        var room = _.findWhere(settings.rooms, { id: data.room.id });
                        settings.rooms = _.without(settings.rooms, room);
                        room.roomContainer.remove();
                        console.log(settings.rooms);
                    });

                    socket.on('create private', function( data ) {
                        roomTemplate = roomPrototype.replace(/\?invitated_id/g, data.users.invitated.id);
                        roomTemplate = roomTemplate.replace(/\?creator_id/g, data.users.creator.id);
                        roomTemplate = roomTemplate.replace(/\?creator_nickname/g, data.users.creator.nickname);
                        roomTemplate = roomTemplate.replace(/\?invitated_nickname/g, data.users.invitated.nickname);
                        roomTemplate = $(roomTemplate);
                        $(settings.roomTo).append(roomTemplate);
                        settings.rooms.push({
                            id: data.id,
                            messagesTo: settings.messagesTo,
                            roomContainer: roomTemplate,
                            messages: []
                        });
                        roomTemplate.find(settings.button).private_send(data.id,roomTemplate.find(settings.input));
                        //settings.onNewPrivateRoom.call( self, data.id, data.users, data.is_single);
                    });

                    socket.on("private message", function(data){
                        var messageItem = messageItemPrototype.replace(/\?nickname/g, data.user_sender.nickname);
                        messageItem = messageItem.replace(/\?message/g, data.text);
                        messageItem = messageItem.replace(/\?avatar/g, data.user_sender.avatar);
                        messageItem = messageItem.replace(/\?id/g, data.user_sender.id);
                        var room = _.findWhere(settings.rooms, {id: data.room.id });
                        room.messages.push(data);
                        if (room.messagesTo == "")
                            room.roomContainer.preppend(messageItem);
                        else
                            room.roomContainer.find(room.messagesTo).prepend(messageItem);
                    });
                }


                $.fn.private_send = function( room_id, getMessageFrom ) {
                    var self = this;
                    self.bind( "click", function(){
                        socket.emit('private message', { id: room_id , text: getMessageFrom.val() });
                    });
                }

                $.new_private_room = function( id ){
                    socket.emit('new single chat', { id: id }); 
                }


                var key = prompt("Enter the chat key","");
                var messageTemplate = "<div class='message' data-id='?id'> <img src='?avatar' heigh='50px' width='50px'></img>  ?nickname: ?message </div>";
                var userTemplate = "<div class='label' data-id='?id'> <img src='?avatar' heigh='50px' width='50px'></img> <span>?nickname</span> </div>";
                var send_input = $(".send_container input");
                var privateRoomTemplate = "<div class='label' data-creator_id='?creator_id' data-invitated_id='?invitated_id'><span><button>Send</button><input></input></span><span class='container'></span></div>"
                $(".google_login").click(function(){
                    $.chat(key);
                    $.login_with_google( {
                        onRefused: function(data) {
                            alert("Social account already in use");
                        },
                        onLogin: function(data) {
                            $(".users_container").on('click', "div" , function(){
                                $.new_private_room($(this).data("id"));
                            });
                            $(".login_container").hide();
                            $("body").public_messages( messageTemplate, { messages: data.messages } );
                            $.private_chats( messageTemplate, privateRoomTemplate, {
                                messagesTo: ".container",
                                roomTo: "body",
                                button: "button",
                                input: "input"
                            });
                            $(".users_container").users_list( userTemplate, { users: data.users,
                                onNewUser: function( user , users ){
                                    console.log(user);
                                    console.log(users);
                                },
                                onDeleteUser: function( user , users ){
                                    console.log(user);
                                    console.log(users);
                                }, 
                            });
                            $(".send_container button").send( send_input );
                        },
                    });
                });
            });

        </script>
    </head>
    <body>
        <div class="login_container">
            <button class="google_login">Login G+</button>
        </div>
        <div class="users_container">
            <div> </div>
        </div>
        <div class="send_container">
            <button>Send</button>
            <input></input>
        </div>
    </body>
</html>
